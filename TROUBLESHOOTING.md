# Решение проблем с подключением к API

## Проблема: Таймаут подключения (408)

Если вы видите ошибки типа "Превышено время ожидания ответа от сервера", выполните следующие шаги:

### 1. Проверьте, запущен ли бэкенд

```bash
cd fire/backend
pnpm run start:dev
```

Убедитесь, что видите сообщение:
```
Server starting on 0.0.0.0:3001
```

### 2. Проверьте URL в логах приложения

При запуске приложения вы должны увидеть в консоли:
```
API Client initialized with base URL: http://10.0.2.2:3001/api
```

**Для Android эмулятора:** `http://10.0.2.2:3001/api`
**Для iOS симулятора:** `http://localhost:3001/api`
**Для физического устройства:** `http://<ваш-ip>:3001/api`

### 3. Проверьте доступность бэкенда

#### С компьютера:
```bash
curl http://localhost:3001/api/objects
# или откройте в браузере:
# http://localhost:3001/api/docs
```

#### Из Android эмулятора:
В эмуляторе откройте браузер и перейдите на:
```
http://10.0.2.2:3001/api/docs
```

### 4. Проверьте переменные окружения бэкенда

Убедитесь, что в `fire/backend/.env.development` (или `.env`) есть:
```
CLIENT_URL=http://localhost:19006
PORT=3001
SESSION_SECRET=your-secret-key
HASH_KEY=your-hash-key
DATABASE_URL=your-database-url
```

### 5. Проверьте файрвол

Убедитесь, что порт 3001 не заблокирован файрволом:
- Windows: Проверьте настройки брандмауэра
- Mac/Linux: Проверьте iptables/firewall

### 6. Для физического устройства

Если используете физическое устройство, вам нужно:

1. Узнать IP-адрес вашего компьютера:
   - Windows: `ipconfig` (IPv4 адрес)
   - Mac/Linux: `ifconfig` или `ip addr`

2. Обновить `api.config.ts`:
   ```typescript
   // Для физического устройства замените localhost на ваш IP
   return 'http://192.168.1.100:3001/api'; // замените на ваш IP
   ```

3. Убедитесь, что устройство и компьютер в одной сети Wi-Fi

### 7. Проверьте логи

В консоли приложения вы должны видеть:
```
[API] GET http://10.0.2.2:3001/api/objects
```

Если URL неправильный, проверьте `api.config.ts`.

### 8. Альтернативные решения

#### Вариант A: Использовать ngrok для туннелирования
```bash
ngrok http 3001
# Используйте полученный URL в api.config.ts
```

#### Вариант B: Использовать локальный IP вместо 10.0.2.2
Если `10.0.2.2` не работает, попробуйте использовать реальный IP вашего компьютера:
```typescript
// В api.config.ts для Android
return 'http://192.168.1.100:3001/api'; // ваш локальный IP
```

### 9. Проверьте CORS

Бэкенд настроен на разрешение всех источников в режиме разработки. Если проблемы остаются, проверьте логи бэкенда на наличие ошибок CORS.

### 10. Перезапустите Metro bundler

Иногда помогает перезапуск:
```bash
# Остановите Metro (Ctrl+C)
# Очистите кеш и перезапустите
npx expo start --clear
```

## Частые ошибки

### "Network request failed"
- Бэкенд не запущен
- Неправильный URL
- Файрвол блокирует соединение

### "CORS error"
- Проверьте настройки CORS в `main.ts`
- Убедитесь, что `CLIENT_URL` правильный

### "401 Unauthorized"
- Токен истек или недействителен
- Попробуйте выйти и войти снова

## Отладка

Включите подробные логи, добавив в начало `apiClient.ts`:
```typescript
console.log('API Base URL:', API_CONFIG.BASE_URL);
```

Все запросы теперь логируются в консоль с префиксом `[API]`.

